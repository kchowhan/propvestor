generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrganizationRole {
  OWNER
  ADMIN
  MANAGER
  ACCOUNTANT
  VIEWER
}

enum PropertyType {
  SINGLE_FAMILY
  MULTI_FAMILY
  CONDO
  COMMERCIAL
  OTHER
}

enum PropertyStatus {
  ACTIVE
  ARCHIVED
}

enum UnitStatus {
  VACANT
  OCCUPIED
  UNDER_RENOVATION
}

enum LeaseStatus {
  DRAFT
  ACTIVE
  TERMINATED
  EXPIRED
}

enum ChargeType {
  RENT
  LATE_FEE
  UTILITY
  SERVICE_FEE // Organization fees (RentSpree, Stripe processing, etc.)
  OTHER
}

enum ChargeStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  CANCELLED
}

enum PaymentMethod {
  MANUAL
  CASH
  CHECK
  BANK_TRANSFER
  ONLINE_PROCESSOR
  STRIPE_ACH
  STRIPE_CARD
  STRIPE_BANK_TRANSFER
}

enum WorkOrderPriority {
  LOW
  NORMAL
  HIGH
  EMERGENCY
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum WorkOrderCategory {
  PLUMBING
  ELECTRICAL
  HVAC
  APPLIANCE
  LANDSCAPING
  PAINTING
  CARPENTRY
  ROOFING
  FLOORING
  GENERAL
  OTHER
}

enum TenantStatus {
  PROSPECT // Just added, not yet screened
  SCREENING // Screening in progress
  APPROVED // Approved but no active lease
  ACTIVE // Has active lease
  INACTIVE // No active lease (former tenant)
  DECLINED // Application declined
  WITHDRAWN // Applicant withdrew
}

enum InvestmentEntityType {
  LLC
  LP
  SPV
  TRUST
  OTHER
}

// HOA Management Enums
enum BoardMemberRole {
  PRESIDENT
  VICE_PRESIDENT
  SECRETARY
  TREASURER
  MEMBER_AT_LARGE
}

enum HomeownerStatus {
  ACTIVE
  INACTIVE
  DELINQUENT
  SUSPENDED
}

enum HOAFeeType {
  MONTHLY_DUES
  SPECIAL_ASSESSMENT
  LATE_FEE
  VIOLATION_FEE
  TRANSFER_FEE
  OTHER
}

enum HOAFeeStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
}

model User {
  id                           String                   @id @default(uuid()) @db.Uuid
  email                        String                   @unique
  passwordHash                 String
  name                         String
  isSuperAdmin                 Boolean                  @default(false)
  emailVerified                Boolean                  @default(false)
  emailVerificationToken       String?                  @unique
  emailVerificationTokenExpiry DateTime?
  createdAt                    DateTime                 @default(now())
  updatedAt                    DateTime                 @updatedAt
  memberships                  OrganizationMembership[]
  documents                    Document[]               @relation("UploadedBy")
  reconciliationsReviewed      Reconciliation[]         @relation("ReviewedBy")
  boardMemberships             BoardMember[]            @relation("BoardMemberUser") // HOA board memberships
}

// Organization is the central entity that contains BOTH property management and investment management data.
// The same user with the same role can access all features within an organization.
// There is no separation between property management and investment management - they are unified.
model Organization {
  id                         String                   @id @default(uuid()) @db.Uuid
  name                       String
  slug                       String                   @unique
  stripeCustomerId           String?                  @unique // Stripe customer for organization fees and subscriptions
  defaultPaymentMethodId     String? // Stripe payment method ID for default payment
  paymentMethodSetupComplete Boolean                  @default(false) // Track if org has completed payment setup
  createdAt                  DateTime                 @default(now())
  updatedAt                  DateTime                 @updatedAt
  memberships                OrganizationMembership[]
  // Property Management (Phase 1)
  properties                 Property[]
  tenants                    Tenant[]
  leases                     Lease[]
  charges                    Charge[]
  payments                   Payment[]
  workOrders                 WorkOrder[]
  vendors                    Vendor[]
  documents                  Document[]
  screeningRequests          ScreeningRequest[]
  // Investment Management (Phase 2)
  investors                  Investor[]
  entities                   InvestmentEntity[]
  // Payment processing
  tenantPaymentMethods       TenantPaymentMethod[]
  bankTransactions           BankTransaction[]
  reconciliations            Reconciliation[]
  // SaaS - Subscriptions
  subscription               Subscription?
  // Organization fees (RentSpree, Stripe processing, etc.)
  organizationFees           OrganizationFee[]
  // HOA Management (Phase 3)
  associations               Association[]
}

// OrganizationMembership links a User to an Organization with a single role.
// This role applies to ALL features within the organization:
// - Property Management (properties, tenants, leases, work orders, etc.)
// - Investment Management (entities, investors, contributions, distributions, etc.)
// The same user with the same role can access both property and investment features.
model OrganizationMembership {
  id             String           @id @default(uuid()) @db.Uuid
  userId         String           @db.Uuid
  organizationId String           @db.Uuid
  role           OrganizationRole // This role applies to both property AND investment management
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([userId, organizationId])
}

// HOA Management Models

// Association represents an HOA/Community managed by an Organization
// One Organization (property management company) can manage multiple Associations
model Association {
  id              String   @id @default(uuid()) @db.Uuid
  organizationId  String   @db.Uuid
  name            String
  addressLine1    String?
  addressLine2    String?
  city            String?
  state           String?
  postalCode      String?
  country         String?  @default("USA")
  phone           String?
  email           String?
  website         String?
  // Settings
  fiscalYearStart Int?     @default(1) // Month (1-12) when fiscal year starts
  // Metadata
  notes           String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization   Organization             @relation(fields: [organizationId], references: [id])
  homeowners     Homeowner[]
  boardMembers   BoardMember[]
  hoaFees        HOAFee[] // HOA fees for all homeowners
  payments       HomeownerPayment[] // Payments from homeowners
  paymentMethods HomeownerPaymentMethod[] // Payment methods for homeowners
  // Future: violations, architectural reviews, funds, events, etc.

  @@index([organizationId])
  @@index([isActive])
}

// Homeowner represents an owner of a unit in an Association
// Different from Tenant (who rents) - Homeowners own their units
model Homeowner {
  id                           String          @id @default(uuid()) @db.Uuid
  associationId                String          @db.Uuid
  unitId                       String?         @db.Uuid // Which unit they own (optional for now)
  propertyId                   String?         @db.Uuid // Which property (if unit not specified)
  // Personal info
  firstName                    String
  lastName                     String
  email                        String
  phone                        String?
  // Account info
  accountBalance               Decimal         @default(0) @db.Decimal(12, 2) // Current balance owed
  // Status
  status                       HomeownerStatus @default(ACTIVE)
  // Authentication (for portal access)
  passwordHash                 String? // Optional - for portal login
  emailVerified                Boolean         @default(false)
  emailVerificationToken       String?         @unique
  emailVerificationTokenExpiry DateTime?
  // Metadata
  notes                        String?
  archivedAt                   DateTime?
  createdAt                    DateTime        @default(now())
  updatedAt                    DateTime        @updatedAt

  association         Association              @relation(fields: [associationId], references: [id])
  unit                Unit?                    @relation(fields: [unitId], references: [id])
  property            Property?                @relation(fields: [propertyId], references: [id])
  boardMemberships    BoardMember[]            @relation("BoardMemberHomeowner") // Board memberships (can have multiple over time)
  hoaFees             HOAFee[] // HOA fees and dues
  payments            HomeownerPayment[] // Payments made by homeowner
  paymentMethods      HomeownerPaymentMethod[] // Payment methods (Stripe)
  maintenanceRequests WorkOrder[]              @relation("RequestedByHomeowner") // Maintenance requests submitted by homeowner

  @@unique([associationId, email])
  @@index([associationId])
  @@index([unitId])
  @@index([propertyId])
  @@index([status])
  @@index([email])
}

// BoardMember represents a board member of an Association
// Links a User (property manager or homeowner) to an Association with a board role
model BoardMember {
  id            String          @id @default(uuid()) @db.Uuid
  associationId String          @db.Uuid
  userId        String?         @db.Uuid // If board member is a User (property manager)
  homeownerId   String?         @db.Uuid // If board member is a Homeowner
  role          BoardMemberRole
  // Tenure
  startDate     DateTime
  endDate       DateTime? // null if currently active
  isActive      Boolean         @default(true)
  // Metadata
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  association Association @relation(fields: [associationId], references: [id])
  user        User?       @relation("BoardMemberUser", fields: [userId], references: [id])
  homeowner   Homeowner?  @relation("BoardMemberHomeowner", fields: [homeownerId], references: [id])
  // Future: approvals, votes, etc.

  @@index([associationId])
  @@index([userId])
  @@index([homeownerId])
  @@index([isActive])
}

model Property {
  id              String         @id @default(uuid()) @db.Uuid
  organizationId  String         @db.Uuid
  name            String
  addressLine1    String
  addressLine2    String?
  city            String
  state           String
  postalCode      String
  country         String
  type            PropertyType
  status          PropertyStatus @default(ACTIVE)
  purchasePrice   Decimal?       @db.Decimal(12, 2)
  acquisitionDate DateTime?
  notes           String?
  archivedAt      DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  organization Organization        @relation(fields: [organizationId], references: [id])
  units        Unit[]
  charges      Charge[]
  workOrders   WorkOrder[]
  documents    Document[]
  ownerships   Ownership[]
  valuations   ValuationSnapshot[]
  tenants      Tenant[]
  homeowners   Homeowner[] // HOA homeowners (if unit not specified)

  @@index([organizationId])
}

model Unit {
  id         String     @id @default(uuid()) @db.Uuid
  propertyId String     @db.Uuid
  name       String
  bedrooms   Int?
  bathrooms  Float?
  squareFeet Int?
  marketRent Decimal?   @db.Decimal(12, 2)
  status     UnitStatus @default(VACANT)
  archivedAt DateTime?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  property   Property    @relation(fields: [propertyId], references: [id])
  leases     Lease[]
  charges    Charge[]
  workOrders WorkOrder[]
  documents  Document[]
  tenants    Tenant[]
  homeowners Homeowner[] // HOA homeowners who own this unit

  @@index([propertyId])
}

// Tenant represents both applicants and active tenants
// Status determines their current stage in the rental process
model Tenant {
  id               String       @id @default(uuid()) @db.Uuid
  organizationId   String       @db.Uuid
  firstName        String
  lastName         String
  email            String?
  phone            String?
  notes            String?
  // Application/Property context (for applicants/prospects)
  propertyId       String?      @db.Uuid
  unitId           String?      @db.Uuid
  // Status: PROSPECT, SCREENING, APPROVED, ACTIVE, INACTIVE, DECLINED, WITHDRAWN
  status           TenantStatus @default(PROSPECT)
  // Stripe integration (only for active tenants)
  stripeCustomerId String?      @unique
  archivedAt       DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  organization      Organization          @relation(fields: [organizationId], references: [id])
  property          Property?             @relation(fields: [propertyId], references: [id])
  unit              Unit?                 @relation(fields: [unitId], references: [id])
  leases            LeaseTenant[]
  workOrders        WorkOrder[]           @relation("RequestedBy")
  documents         Document[]
  paymentMethods    TenantPaymentMethod[]
  screeningRequests ScreeningRequest[]

  @@index([organizationId])
  @@index([propertyId])
  @@index([unitId])
  @@index([status])
}

// ScreeningRequest tracks a tenant screening request via RentSpree
model ScreeningRequest {
  id                  String    @id @default(uuid()) @db.Uuid
  organizationId      String    @db.Uuid
  tenantId            String    @db.Uuid
  // RentSpree integration
  externalRequestId   String?   @unique // RentSpree application/request ID
  applicationUrl      String? // Link for applicant to complete screening
  // Status tracking: PENDING, IN_PROGRESS, COMPLETED, APPROVED, BORDERLINE, DECLINED, ERROR
  status              String    @default("PENDING")
  // Screening results (summary fields from RentSpree)
  recommendation      String? // 'APPROVED', 'BORDERLINE', 'DECLINED'
  creditScore         Int? // Credit score if available
  incomeVerified      Boolean?  @default(false)
  evictionHistory     Boolean?  @default(false)
  criminalHistory     Boolean?  @default(false)
  flags               String? // JSON array of flags/warnings
  // PDF report
  reportPdfUrl        String? // URL to full screening report PDF
  // FCRA compliance
  adverseActionSent   Boolean   @default(false)
  adverseActionSentAt DateTime?
  // Metadata
  requestedAt         DateTime  @default(now())
  completedAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id])
  tenant           Tenant            @relation(fields: [tenantId], references: [id])
  organizationFees OrganizationFee[]

  @@index([organizationId])
  @@index([tenantId])
  @@index([externalRequestId])
  @@index([status])
}

model Lease {
  id                 String      @id @default(uuid()) @db.Uuid
  organizationId     String      @db.Uuid
  unitId             String      @db.Uuid
  startDate          DateTime
  endDate            DateTime
  rentAmount         Decimal     @db.Decimal(12, 2)
  depositAmount      Decimal?    @db.Decimal(12, 2)
  rentDueDay         Int
  status             LeaseStatus @default(DRAFT)
  // DocuSign tracking
  docusignEnvelopeId String?     @unique
  signatureStatus    String? // 'sent', 'delivered', 'signed', 'completed', 'declined', 'voided'
  signedPdfUrl       String? // URL to the signed PDF in GCS
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id])
  unit         Unit          @relation(fields: [unitId], references: [id])
  tenants      LeaseTenant[]
  charges      Charge[]
  payments     Payment[]
  documents    Document[]

  @@index([organizationId])
  @@index([unitId])
}

model LeaseTenant {
  id        String  @id @default(uuid()) @db.Uuid
  leaseId   String  @db.Uuid
  tenantId  String  @db.Uuid
  isPrimary Boolean @default(false)

  lease  Lease  @relation(fields: [leaseId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([leaseId, tenantId])
  @@index([tenantId])
}

model Charge {
  id             String       @id @default(uuid()) @db.Uuid
  organizationId String       @db.Uuid
  propertyId     String?      @db.Uuid
  unitId         String?      @db.Uuid
  leaseId        String?      @db.Uuid
  type           ChargeType
  description    String
  amount         Decimal      @db.Decimal(12, 2)
  dueDate        DateTime
  status         ChargeStatus @default(PENDING)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id])
  property         Property?         @relation(fields: [propertyId], references: [id])
  unit             Unit?             @relation(fields: [unitId], references: [id])
  lease            Lease?            @relation(fields: [leaseId], references: [id])
  payments         Payment[]
  organizationFees OrganizationFee[]

  @@index([organizationId])
  @@index([leaseId])
}

model Payment {
  id                    String        @id @default(uuid()) @db.Uuid
  organizationId        String        @db.Uuid
  leaseId               String?       @db.Uuid
  chargeId              String?       @db.Uuid
  amount                Decimal       @db.Decimal(12, 2)
  receivedDate          DateTime
  method                PaymentMethod
  reference             String?
  // Stripe integration
  stripePaymentIntentId String?       @unique
  stripeChargeId        String?       @unique
  stripeCustomerId      String?
  stripePaymentMethodId String?
  // Reconciliation
  reconciled            Boolean       @default(false)
  reconciliationId      String?       @db.Uuid
  bankTransactionId     String?       @unique @db.Uuid
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  organization        Organization         @relation(fields: [organizationId], references: [id])
  lease               Lease?               @relation(fields: [leaseId], references: [id])
  charge              Charge?              @relation(fields: [chargeId], references: [id])
  reconciliation      Reconciliation?      @relation(fields: [reconciliationId], references: [id])
  bankTransaction     BankTransaction?     @relation(fields: [bankTransactionId], references: [id])
  paymentMethod       TenantPaymentMethod? @relation(fields: [stripePaymentMethodId], references: [stripePaymentMethodId])
  reconciliationMatch ReconciliationMatch? @relation("MatchPayment")
  organizationFees    OrganizationFee[]

  @@index([organizationId])
  @@index([chargeId])
  @@index([stripePaymentIntentId])
  @@index([reconciliationId])
}

// Payment methods stored for tenants (bank accounts, cards via Stripe)
model TenantPaymentMethod {
  id                    String   @id @default(uuid()) @db.Uuid
  tenantId              String   @db.Uuid
  organizationId        String   @db.Uuid
  stripePaymentMethodId String   @unique // Stripe payment method ID
  type                  String // 'ach_debit', 'card', 'us_bank_account'
  isDefault             Boolean  @default(false)
  // Bank account details (last 4 digits, bank name)
  last4                 String?
  bankName              String?
  // Card details (last 4 digits, brand, expiry)
  cardBrand             String?
  cardExpMonth          Int?
  cardExpYear           Int?
  // Status
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  payments     Payment[]

  @@index([tenantId])
  @@index([organizationId])
  @@index([stripePaymentMethodId])
}

// Bank transactions imported from bank statements
model BankTransaction {
  id               String   @id @default(uuid()) @db.Uuid
  organizationId   String   @db.Uuid
  // Transaction details
  date             DateTime
  amount           Decimal  @db.Decimal(12, 2)
  description      String
  reference        String? // Check number, transaction ID, etc.
  // Bank account info
  accountNumber    String? // Last 4 digits
  accountName      String?
  // Reconciliation
  reconciled       Boolean  @default(false)
  reconciliationId String?  @db.Uuid
  paymentId        String?  @db.Uuid
  // Import metadata
  importedAt       DateTime @default(now())
  importSource     String? // 'csv', 'ofx', 'manual', etc.
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization        Organization         @relation(fields: [organizationId], references: [id])
  reconciliation      Reconciliation?      @relation(fields: [reconciliationId], references: [id])
  payment             Payment?
  reconciliationMatch ReconciliationMatch? @relation("MatchTransaction")

  @@index([organizationId])
  @@index([reconciliationId])
  @@index([date])
}

// Reconciliation records
model Reconciliation {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @db.Uuid
  // Period
  startDate      DateTime
  endDate        DateTime
  // Status: PENDING, IN_PROGRESS, COMPLETED, REVIEWED
  status         String    @default("PENDING")
  // Totals
  expectedTotal  Decimal?  @db.Decimal(12, 2)
  actualTotal    Decimal?  @db.Decimal(12, 2)
  difference     Decimal?  @db.Decimal(12, 2)
  // Metadata
  notes          String?
  reviewedBy     String?   @db.Uuid
  reviewedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization     Organization          @relation(fields: [organizationId], references: [id])
  reviewer         User?                 @relation("ReviewedBy", fields: [reviewedBy], references: [id])
  payments         Payment[]
  bankTransactions BankTransaction[]
  matches          ReconciliationMatch[]

  @@index([organizationId])
  @@index([startDate, endDate])
}

// HOA Fee/Due - Recurring or one-time charges for homeowners
model HOAFee {
  id                String       @id @default(uuid()) @db.Uuid
  associationId     String       @db.Uuid
  homeownerId       String       @db.Uuid
  type              HOAFeeType
  description       String
  amount            Decimal      @db.Decimal(12, 2)
  dueDate           DateTime
  status            HOAFeeStatus @default(PENDING)
  // Recurring fee settings
  isRecurring       Boolean      @default(false)
  recurringInterval String? // 'monthly', 'quarterly', 'annually'
  nextDueDate       DateTime? // For recurring fees
  // Late fee calculation
  lateFeeAmount     Decimal?     @db.Decimal(12, 2)
  lateFeeApplied    Boolean      @default(false)
  lateFeeAppliedAt  DateTime?
  // Metadata
  notes             String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  association Association        @relation(fields: [associationId], references: [id])
  homeowner   Homeowner          @relation(fields: [homeownerId], references: [id])
  payments    HomeownerPayment[]

  @@index([associationId])
  @@index([homeownerId])
  @@index([dueDate])
  @@index([status])
}

// Homeowner Payment - Payments made by homeowners for HOA fees
model HomeownerPayment {
  id                    String        @id @default(uuid()) @db.Uuid
  associationId         String        @db.Uuid
  homeownerId           String        @db.Uuid
  hoaFeeId              String?       @db.Uuid
  amount                Decimal       @db.Decimal(12, 2)
  receivedDate          DateTime
  method                PaymentMethod
  reference             String?
  // Stripe integration
  stripePaymentIntentId String?       @unique
  stripeChargeId        String?       @unique
  stripeCustomerId      String?
  stripePaymentMethodId String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  association   Association             @relation(fields: [associationId], references: [id])
  homeowner     Homeowner               @relation(fields: [homeownerId], references: [id])
  hoaFee        HOAFee?                 @relation(fields: [hoaFeeId], references: [id])
  paymentMethod HomeownerPaymentMethod? @relation(fields: [stripePaymentMethodId], references: [stripePaymentMethodId])

  @@index([associationId])
  @@index([homeownerId])
  @@index([hoaFeeId])
  @@index([stripePaymentIntentId])
}

// Payment methods stored for homeowners (bank accounts, cards via Stripe)
model HomeownerPaymentMethod {
  id                    String   @id @default(uuid()) @db.Uuid
  homeownerId           String   @db.Uuid
  associationId         String   @db.Uuid
  stripePaymentMethodId String   @unique // Stripe payment method ID
  type                  String // 'ach_debit', 'card', 'us_bank_account'
  isDefault             Boolean  @default(false)
  // Bank account details (last 4 digits, bank name)
  last4                 String?
  bankName              String?
  // Card details (last 4 digits, brand, expiry)
  cardBrand             String?
  cardExpMonth          Int?
  cardExpYear           Int?
  // Status
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  homeowner   Homeowner          @relation(fields: [homeownerId], references: [id])
  association Association        @relation(fields: [associationId], references: [id])
  payments    HomeownerPayment[]

  @@index([homeownerId])
  @@index([associationId])
  @@index([stripePaymentMethodId])
}

// Matches between payments and bank transactions
model ReconciliationMatch {
  id                String   @id @default(uuid()) @db.Uuid
  reconciliationId  String?  @db.Uuid
  paymentId         String?  @unique @db.Uuid
  bankTransactionId String?  @unique @db.Uuid
  // Match details
  matchType         String // 'auto', 'manual', 'suggested'
  confidence        Decimal? @db.Decimal(5, 2) // 0-100, for auto matches
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  reconciliation  Reconciliation?  @relation(fields: [reconciliationId], references: [id])
  payment         Payment?         @relation("MatchPayment", fields: [paymentId], references: [id])
  bankTransaction BankTransaction? @relation("MatchTransaction", fields: [bankTransactionId], references: [id])

  @@index([reconciliationId])
  @@index([paymentId])
  @@index([bankTransactionId])
}

model WorkOrder {
  id                     String            @id @default(uuid()) @db.Uuid
  organizationId         String            @db.Uuid
  propertyId             String            @db.Uuid
  unitId                 String?           @db.Uuid
  title                  String
  description            String
  category               WorkOrderCategory @default(GENERAL)
  priority               WorkOrderPriority @default(NORMAL)
  status                 WorkOrderStatus   @default(OPEN)
  requestedByTenantId    String?           @db.Uuid
  requestedByHomeownerId String?           @db.Uuid // New: for homeowner-submitted requests
  assignedVendorId       String?           @db.Uuid
  estimatedCost          Decimal?          @db.Decimal(12, 2)
  actualCost             Decimal?          @db.Decimal(12, 2)
  openedAt               DateTime          @default(now())
  completedAt            DateTime?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt

  organization         Organization @relation(fields: [organizationId], references: [id])
  property             Property     @relation(fields: [propertyId], references: [id])
  unit                 Unit?        @relation(fields: [unitId], references: [id])
  requestedBy          Tenant?      @relation("RequestedBy", fields: [requestedByTenantId], references: [id])
  requestedByHomeowner Homeowner?   @relation("RequestedByHomeowner", fields: [requestedByHomeownerId], references: [id])
  assignedVendor       Vendor?      @relation(fields: [assignedVendorId], references: [id])

  @@index([organizationId])
  @@index([propertyId])
  @@index([category])
  @@index([requestedByHomeownerId])
}

model Vendor {
  id             String            @id @default(uuid()) @db.Uuid
  organizationId String            @db.Uuid
  name           String
  email          String?
  phone          String
  website        String?
  category       WorkOrderCategory @default(GENERAL)
  notes          String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  workOrders   WorkOrder[]

  @@index([organizationId])
  @@index([category])
}

model Document {
  id               String   @id @default(uuid()) @db.Uuid
  organizationId   String   @db.Uuid
  propertyId       String?  @db.Uuid
  unitId           String?  @db.Uuid
  leaseId          String?  @db.Uuid
  tenantId         String?  @db.Uuid
  fileName         String
  fileType         String
  storageKey       String
  uploadedByUserId String   @db.Uuid
  uploadedAt       DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  property     Property?    @relation(fields: [propertyId], references: [id])
  unit         Unit?        @relation(fields: [unitId], references: [id])
  lease        Lease?       @relation(fields: [leaseId], references: [id])
  tenant       Tenant?      @relation(fields: [tenantId], references: [id])
  uploadedBy   User         @relation("UploadedBy", fields: [uploadedByUserId], references: [id])

  @@index([organizationId])
}

model Investor {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @db.Uuid
  name           String
  email          String?
  phone          String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization  Organization          @relation(fields: [organizationId], references: [id])
  ownerships    Ownership[]
  contributions CapitalContribution[]
  distributions Distribution[]

  @@index([organizationId])
}

model InvestmentEntity {
  id             String               @id @default(uuid()) @db.Uuid
  organizationId String               @db.Uuid
  name           String
  type           InvestmentEntityType
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  organization  Organization          @relation(fields: [organizationId], references: [id])
  ownerships    Ownership[]
  contributions CapitalContribution[]
  distributions Distribution[]
  valuations    ValuationSnapshot[]

  @@index([organizationId])
}

model Ownership {
  id                 String   @id @default(uuid()) @db.Uuid
  investmentEntityId String   @db.Uuid
  investorId         String   @db.Uuid
  propertyId         String?  @db.Uuid
  percentage         Decimal  @db.Decimal(5, 2)
  effectiveDate      DateTime
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  investmentEntity InvestmentEntity @relation(fields: [investmentEntityId], references: [id])
  investor         Investor         @relation(fields: [investorId], references: [id])
  property         Property?        @relation(fields: [propertyId], references: [id])

  @@index([investmentEntityId])
  @@index([investorId])
}

model CapitalContribution {
  id                 String   @id @default(uuid()) @db.Uuid
  investmentEntityId String   @db.Uuid
  investorId         String   @db.Uuid
  date               DateTime
  amount             Decimal  @db.Decimal(12, 2)
  notes              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  investmentEntity InvestmentEntity @relation(fields: [investmentEntityId], references: [id])
  investor         Investor         @relation(fields: [investorId], references: [id])

  @@index([investmentEntityId])
  @@index([investorId])
}

model Distribution {
  id                 String   @id @default(uuid()) @db.Uuid
  investmentEntityId String   @db.Uuid
  investorId         String   @db.Uuid
  date               DateTime
  amount             Decimal  @db.Decimal(12, 2)
  notes              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  investmentEntity InvestmentEntity @relation(fields: [investmentEntityId], references: [id])
  investor         Investor         @relation(fields: [investorId], references: [id])

  @@index([investmentEntityId])
  @@index([investorId])
}

model ValuationSnapshot {
  id                 String   @id @default(uuid()) @db.Uuid
  investmentEntityId String   @db.Uuid
  propertyId         String?  @db.Uuid
  date               DateTime
  value              Decimal  @db.Decimal(14, 2)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  investmentEntity InvestmentEntity @relation(fields: [investmentEntityId], references: [id])
  property         Property?        @relation(fields: [propertyId], references: [id])

  @@index([investmentEntityId])
  @@index([propertyId])
}

// SaaS - Subscription Management
enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model SubscriptionPlan {
  id              String   @id @default(uuid()) @db.Uuid
  name            String // "Free", "Basic", "Pro", "Enterprise"
  slug            String   @unique
  price           Decimal  @db.Decimal(10, 2)
  billingInterval String // "monthly", "annual"
  features        Json // Feature flags: { properties: true, reports: true, api: false }
  limits          Json // Usage limits: { properties: 10, tenants: 50, users: 5, storage: 1000 }
  stripePriceId   String?  @unique // Stripe Price ID
  isActive        Boolean  @default(true)
  displayOrder    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  subscriptions Subscription[]

  @@index([isActive, displayOrder])
}

model Subscription {
  id                   String             @id @default(uuid()) @db.Uuid
  organizationId       String             @unique @db.Uuid
  planId               String             @db.Uuid
  status               SubscriptionStatus // ACTIVE, TRIAL, CANCELLED, EXPIRED, PAST_DUE
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  trialEndsAt          DateTime?
  stripeSubscriptionId String?            @unique
  stripeCustomerId     String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan         SubscriptionPlan @relation(fields: [planId], references: [id])
  invoices     Invoice[]

  @@index([organizationId])
  @@index([status])
  @@index([stripeSubscriptionId])
}

model Invoice {
  id              String        @id @default(uuid()) @db.Uuid
  subscriptionId  String        @db.Uuid
  amount          Decimal       @db.Decimal(10, 2)
  status          InvoiceStatus // PENDING, PAID, FAILED, REFUNDED
  stripeInvoiceId String?       @unique
  dueDate         DateTime
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
  @@index([status])
  @@index([stripeInvoiceId])
}

// Organization fees that the organization pays (RentSpree screening, Stripe processing, etc.)
model OrganizationFee {
  id                 String   @id @default(uuid()) @db.Uuid
  organizationId     String   @db.Uuid
  feeType            String // 'RENTSPREE_SCREENING', 'STRIPE_PROCESSING', etc.
  amount             Decimal  @db.Decimal(12, 2)
  description        String
  // Link to source
  screeningRequestId String?  @db.Uuid // If fee is from RentSpree screening
  paymentId          String?  @db.Uuid // If fee is from Stripe payment processing
  chargeId           String?  @db.Uuid // Charge created for this fee
  // Stripe-specific fields
  stripeFeeAmount    Decimal? @db.Decimal(12, 2) // Actual Stripe fee (if applicable)
  stripeFeeType      String? // 'application_fee', 'processing_fee', etc.
  // Metadata
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id])
  screeningRequest ScreeningRequest? @relation(fields: [screeningRequestId], references: [id])
  payment          Payment?          @relation(fields: [paymentId], references: [id])
  charge           Charge?           @relation(fields: [chargeId], references: [id])

  @@index([organizationId])
  @@index([feeType])
  @@index([screeningRequestId])
  @@index([paymentId])
  @@index([chargeId])
}
